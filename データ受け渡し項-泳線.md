

# 1) 要素ごとのプロトコル（データ受け渡し項目表）

## 1.1 コンテンツ基礎モデル（論理データ辞書）

| フィールド                | 型/制約                          | 説明                |
| -------------------- | ----------------------------- | ----------------- |
| id                   | string（`^[a-z0-9-]+$`）必須      | URL識別子            |
| 語                    | string（1..50）必須               | 見出し語              |
| 読み                   | string（1..50）必須               | ひらがな表記            |
| 品詞                   | enum（名詞/動詞/形容/感嘆/接辞…）必須       | 便宜上の品詞            |
| 初出                   | string（`vX.Y (YYYY-MM-DD)`）任意 | 初公開版と日付           |
| 怖度                   | int（1..5）必須                   | 1=気配〜5=明確         |
| タグ.情緒                | string\[]（0..3）               | 例：不在/記憶/郷愁…（固定辞書） |
| タグ.モチーフ              | string\[]（0..3）               | 例：窓/駅/水/鏡/階段…     |
| タグ.仕掛け               | string\[]（0..3）               | 例：用法二層/反復/時制逆転…   |
| 関連                   | string\[]（0..4）               | 他語のid参照（手動リンク）    |
| A11y.contentWarnings | string\[]                     | 例：溺れ・呼吸困難の想起      |
| 表の意味                 | text（100–140字）必須              | 定義A               |
| 用例A                  | text（1–2行）必須                  | 例文A               |
| 裏の意味                 | text（\~250字目安）必須              | 定義B（示唆的）          |
| 手がかり                 | string\[]（0..3）               | 箇条書き短文            |
| 用例B                  | text（1–2行）必須                  | 例文B               |

**派生（ビルド時生成）**

* 抜粋（excerpt）…表の意味の先頭 \~120字
* 音韻キー（phoneticKey）…先頭音・母音系列・子音群の簡易キー
* 公開可否（scaryAllowed）…`怖度 ≤ ユーザー上限`
* 関連計算結果（relatedComputed\[]）…スコア順（下記1.4）

---

## 1.2 ページ別 I/O（入出力契約）

### TOP（/）

**入力**

* latest: Word\[8]（初出降順）
* popular: Word\[6] + popularityMetrics（展開率, CTR, 滞在）
* tagDictionary: 固定辞書（情緒/モチーフ/仕掛け）
* userPrefs: { scaryMax: number（初期3） }

**出力/状態**

* 怖度フィルタ（scaryMax）…一覧/人気/タグ結果を即時反映
* タグ選択（facets）…AND/OR、各カテゴリ最大3
* カードリスト（WordCard\[]）
* 空状態メッセージ（結果0のとき）

**イベント**

* filter\_applied{facets, scary\_max}
* popular\_tab{tab}
* card\_click{id, position}
* card\_impression{id}（遅延送信）

---

### 詳細（/w/{id}）

**入力**

* word: Word（1件）
* related: RelatedItem\[≤4]（`S ≥ 3`で抽出・同点は初出新しい順）
* userPrefs: { scaryMax }

**出力/状態**

* CWsバッジ（該当時）
* 表（常時表示）／裏（折りたたみ・初期閉）
* 怖度ガード：`word.怖度 > scaryMax` の場合でも**ページ表示可**、ただし裏は閉＋CWsを上部表示
* 関連カード（自己参照なし）

**イベント**

* open\_details{id, opened, time\_to\_open}
* related\_click{from\_id, to\_id, score}

---

### タグ一覧（/tags/{k}）

**入力**

* tagDictionary, userPrefs.scaryMax
* filters: { mode: 'AND'|'OR', 情緒\[], モチーフ\[], 仕掛け\[] }

**出力/状態**

* 件数・並び順（初出/人気/語順）
* 結果カードグリッド（WordCard\[]）
* 空状態＋近いタグ候補（同カテゴリ共起Top3）

**イベント**

* filter\_applied{facets, scary\_max}

---

### 検索（トップの共通バー）

**入力**

* q: string（0..50）
* index: { 語^4, 読み^3, タグ^2, 表の意味^1 }

**出力/状態**

* サジェスト（最大6：語3/タグ2/結果件数1）
* 結果ハイライト（一覧／詳細直行）

**イベント**

* search{q\_len, results, decided\_type}

---

## 1.3 コンポーネント契約（入出力・状態）

### WordCard

| 項目       | 型                                        | 必須 | 説明                                        |
| -------- | ---------------------------------------- | -- | ----------------------------------------- |
| id       | string                                   | ✔  | クリックで詳細へ                                  |
| 語        | string                                   | ✔  | 見出し                                       |
| 読み       | string                                   | ✔  | ふりがな                                      |
| 怖度       | number(1..5)                             | ✔  | ●×5                                       |
| タグ主要     | {情緒?\:string,モチーフ?\:string,仕掛け?\:string} |    | 最大3表示                                     |
| 抜粋       | string                                   | ✔  | 表の意味先頭 \~120字                             |
| 初出       | string                                   |    | vX.Y (YYYY-MM-DD)                         |
| disabled | boolean                                  |    | `怖度 > scaryMax`時は**カード自体を非表示**（詳細直リンクのみ可） |

### WordEntry（詳細の本文）

| 項目      | 型                         | 必須 | 説明    |
| ------- | ------------------------- | -- | ----- |
| header  | {語, 読み, 品詞, 怖度, 初出}       | ✔  | 見出し帯  |
| cws     | string\[]                 |    | バッジ列  |
| front   | {定義A, 用例A}                | ✔  | 常時    |
| back    | {定義B, 手がかり\[], 用例B}       | ✔  | 折りたたみ |
| related | {id, 語, 読み, 怖度, score}\[] |    | 最大4   |

### Spoiler（折りたたみ）

| 項目                        | 型                           | 説明              |
| ------------------------- | --------------------------- | --------------- |
| summaryLabelClosed / Open | string                      | 「裏の意味をひらく/とじる」  |
| opened                    | boolean                     | 初期`false`       |
| onToggle                  | event                       | open\_details発火 |
| a11y                      | aria-expanded/labelledby 連携 |                 |

### TagChips

| 項目       | 型                        | 説明                |           |
| -------- | ------------------------ | ----------------- | --------- |
| mode     | 'AND'                    | 'OR'              | AND/ORトグル |
| selected | {情緒\[], モチーフ\[], 仕掛け\[]} | 各カテゴリ≤3           |           |
| onChange | event                    | filter\_applied発火 |           |

### SearchBar

| 項目          | 型             | 説明       |
| ----------- | ------------- | -------- |
| q           | string        | 入力値      |
| suggestions | Suggestion\[] | 最大6      |
| onDecide    | event         | search発火 |
| shortcut    | '/'           | フォーカス移動  |

---

## 1.4 関連語スコア（仕様確定）

* 式：`S = 3*T + 2*P + 1*H`

  * `T`…タグ一致ユニーク数（情緒/モチーフ/仕掛けの合計、上限3）
  * `P`…音韻近接（先頭音一致=1、母音系列一致=1、子音群部分一致=1／最大2）
  * `H`…手動リンク（関連\[]内に相互参照があれば+1）
* 表示条件：`S ≥ 3`、最大4件。スコア同点は**初出が新しい順**。
* 禁則：自己参照不可／スコアが0の語は候補から除外。

---

## 1.5 イベント計測スキーマ（型定義）

| イベント名            | 必須項目                     | 任意項目                            | 送信タイミング    |
| ---------------- | ------------------------ | ------------------------------- | ---------- |
| pageview         | path                     | ref                             | ページ表示      |
| filter\_applied  | scary\_max, facets（JSON） | source（top/tags）                | フィルタ変更時    |
| popular\_tab     | tab（latest/popular）      |                                 | タブ切替       |
| card\_impression | id                       | position                        | 1秒以上可視時    |
| card\_click      | id, position             | from（top/tags/search）           | カード押下      |
| search           | q\_len, results          | decided\_type（detail/list/none） | Enter/決定時  |
| open\_details    | id, opened（bool）         | time\_to\_open（ms）              | 裏summary開閉 |
| related\_click   | from\_id, to\_id, score  | position                        | 関連カード押下    |

**制約**：個人情報なし／IPは解析側で匿名化。イベント総量は1PVあたり≤20を目安。

---

## 1.6 バリデーション規則（編集時チェック）

* 文字数：表=100–140字、用例A/B=各1–2行、手がかり≤3。
* タグ上限：各カテゴリ≤3、総タグ数が多すぎる場合は削減。
* 怖度5：基本非公開（審査保留）。
* 固有名詞：実在名は伏せ表現。
* 関連：≤4、自己参照禁止、同一id重複禁止。
* 読み：ひらがな推奨（カタカナ/漢字読みは「読み」で併記可）。
* CWs：該当時に限り列挙。過不足はレビューで調整。

---

## 1.7 エンプティ/エラー状態（UIルール）

* 検索0件：案内＋タグ検索例（`#記憶`）をサジェスト。
* タグ結果0件：近いタグ提案（同カテゴリ共起Top3）。
* 怖度ガード：一覧/関連で**非表示**、詳細直リンクのみ**可視（裏は閉）**。
* 404：検索バー＋人気/タグ導線を提示。

---

# 2) 編集・公開の業務フロー図（泳線）

## 2.1 編集〜公開（Admin-only）泳線

```
泳線:  編集者        | レビュア（任意） | CI/検証           | 本番サイト
──────────────────────────────────────────────────────────
開始                 |                  |                   |
下書き作成           |                  |                   |
（テンプレに沿って   |                  |                   |
 表/裏/手がかり記述）|                  |                   |
──────────────────────────────────────────────────────────
自己チェック         |                  |                   |
（文字数/タグ/関連） |                  |                   |
─────────────┬───────┴───────────────┬──────────
             | レビュー依頼（任意）      | validate 実行     |
             |（表現/トーン/A11y確認）   |（文言ルール/タグ）|
             |                          |（重複id/関連禁則）|
             | 承認or修正依頼           | 異常→差戻し       |
─────────────┴──────────┬───────────────┴──────────
公開可否判断                         | build/プレビュー生成 |
（怖度/CWs最終判断）                 | （一覧/詳細確認）   |
─────────────┬──────────┴───────────────────────────
初出を確定        |                                          |
（vX.Y (日付)）   |                                          |
─────────────┴─────────────────────────────────────────
公開（本番反映）  |                                          |
──────────────────────────────────────────────────────────
計測確認（展開率/CTR）→ 人気リスト更新（日次） → 改稿必要性の判断
```

**品質ゲート（通過条件）**

* 定義A 100–140字 / 用例A/B各1–2行 / 手がかり≤3
* タグ各≤3 / 関連≤4（自己参照なし）
* 怖度≤3（公開即）、4は要注意喚起、5は保留
* A11y（見出し階層/フォーカス/コントラスト）合格

---

## 2.2 削除・修正要請（外部からの連絡）泳線

```
泳線:  連絡者   | 運用窓口（編集者） | 方針確認/記録         | サイト
────────────────────────────────────────────────────────
要請送付        |                     |                      |
（About連絡先へ）| 受領→受付番号発行    | 受付ログ/内容分類       |
───────────────┬───────────────┬───────────────
               | 事実確認（対象箇所）  | 既存ポリシー照合       |
               | 表現/固有名/誤解点     | （CWs,怖度,伏せ方）    |
───────────────┴───────────────┬───────────────
回答（48h以内）                       | 対応案の記録           |
（中間報告）                          |（修正/非公開/却下）    |
───────────────┬───────────────┴───────────────
修正/非公開の実施                     | 変更履歴に記録         | 反映
最終回答送付                          |                       |
```

**判断基準（例）**

* 実在個人の特定 → 即時修正/匿名化
* 過度な恐怖喚起（CWs漏れ） → 追記・怖度再評価
* 誤読誘発が強すぎる → 手がかり修正（3点以内で調整）

---

## 2.3 人気指標（展開率）更新フロー

```
イベント収集（open_details / related_click / 滞在）
        ↓（日次集計）
展開率 = open_details_open / 詳細PV
関連記事CTR = related_click / 閲覧語数
        ↓
人気リスト（上位N）更新
        ↓
TOP「人気」タブの並べ替え反映
```

**注意**：短期スパイク抑制のため、直近7日/30日可変窓で集計。

---

## 2.4 月次運用（ルーチン）

* 追加目標：**最低5語**
* 既存見直し：反応上位語の**CWs/怖度再点検**
* タグ辞書の棚卸し：重複・過多タグの縮減
* レポート：PV/展開率/CTR/検索クエリTop10（要修正語の抽出）

---

### 付録：RACI（主要タスク）

| タスク          | R（実行）    | A（責任） | C（協議）   | I（通知） |
| ------------ | -------- | ----- | ------- | ----- |
| 新規エントリ執筆     | 編集者      | 編集者   | レビュア    | なし    |
| A11y確認       | レビュア     | 編集者   | ー       | ー     |
| 公開判定（怖度/CWs） | 編集者      | 編集者   | レビュア    | ー     |
| 人気集計更新       | 運用（=編集者） | 編集者   | ー       | ー     |
| 削除・修正要請対応    | 編集者      | 編集者   | 必要に応じ相談 | 連絡者   |

---